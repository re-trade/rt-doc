@startuml
title Product Listing - State Machine Diagram

[*] --> Guest
Guest --> LoggedIn : User Logs In with Credentials
Guest --> ViewingProducts : Browse as Guest

state LoggedIn {
  [*] --> BuyerOrSeller
  BuyerOrSeller --> SellerFlow : Select Seller Role
  BuyerOrSeller --> BuyerFlow : Select Buyer Role

  state SellerFlow {
    [*] --> SwitchToSellerTab
    SwitchToSellerTab --> EnterProductInfo : Fill in name, description, price, condition
    EnterProductInfo --> EnterProductInfo : Invalid Input - Retry
    EnterProductInfo --> Listed : List Product for Sale
    Listed --> WaitingForPurchase
    WaitingForPurchase --> PaymentReceived : Buyer Initiates Payment via PayOS/VNPay
    PaymentReceived --> PaymentReceived : Payment Failed - Retry
    PaymentReceived --> Confirmed : Seller Confirms Receipt of Goods
    Confirmed --> Completed : Transaction Finalized
    WaitingForPurchase --> Canceled : Seller Cancels Listing
    Canceled --> [*]
  }

  state BuyerFlow {
    [*] --> ViewingProducts
    ViewingProducts --> AddToCart : Select Product and Add to Cart
    AddToCart --> Purchasing : Proceed to Checkout
    Purchasing --> PaymentInitiated : Initiate Payment via PayOS/VNPay
    PaymentInitiated --> PaymentInitiated : Payment Failed - Retry
    PaymentInitiated --> OrderConfirmed : Payment Successful
    OrderConfirmed --> Shipped : Seller Ships Product
    Shipped --> ReceivedGoods : Buyer Confirms Receipt
    ReceivedGoods --> Completed : Transaction Finalized
    Purchasing --> Canceled : Buyer Cancels Order
    Canceled --> [*]
  }
}

state Completed {
  [*] --> [*]
}

@enduml


@startuml
title Order Lifecycle - State Machine Diagram

[*] --> Browsing
Browsing --> Viewing : View product details
Viewing --> InCart : Add to cart
InCart --> Paying : Proceed to payment

state Paying {
  [*] --> ProcessingPayment
  ProcessingPayment --> PaymentSuccess : Payment successful
  ProcessingPayment --> PaymentFailed : Payment failed
  ProcessingPayment --> Timeout : Payment timeout

  PaymentSuccess --> Confirmed : Save order, generate invoice,\nsend confirmation email
  PaymentFailed --> RetryPayment : Retry payment
  PaymentFailed --> Cancelled : Exceed retry limit,\nsave failed info,\nshow cancel message,\nsend cancellation email
  Timeout --> Cancelled : Payment timed out,\nsave failed info,\nshow timeout message
  RetryPayment --> ProcessingPayment : Re-initiate payment
}

Confirmed --> Shipped : Seller ships order
Shipped --> Delivered : Buyer confirms delivery
Delivered --> Completed : Order finalized
Cancelled --> [*]
Completed --> [*]

@enduml


@startuml
title Order Processing & Delivery - State Machine Diagram

[*] --> DashboardAccessed
DashboardAccessed --> OrderSelected : Seller views & selects order
OrderSelected --> Preparing : Seller prepares the order
Preparing --> Processing : System updates status to Processing

Processing --> Delivering : Order ready â†’ dispatch to delivery service
Delivering --> Delivered : Delivery confirmed â†’ system updates status
Delivered --> Completed : Buyer confirms receipt, order finalized
Completed --> [*]

Processing --> OnHold : Insufficient stock or delay
OnHold --> Processing : Issue resolved
OnHold --> Cancelled : Issue unresolved after timeout

Processing --> Cancelled : Seller cancels order or payment failed
Delivering --> Returned : Delivery failed, item returned
Returned --> Cancelled : Seller confirms return
Returned --> Processing : Reschedule delivery

Cancelled --> [*]
@enduml

'
@startuml
title Seller Withdrawal - State Machine Diagram

[*] --> WithdrawalRequested : Seller submits withdrawal request
WithdrawalRequested --> ValidationPending : System validates request (balance, details)

ValidationPending --> WaitingApproval : Validation successful
ValidationPending --> InvalidRequest : Insufficient balance or invalid data
InvalidRequest --> Cancelled : Notify seller, request cancelled
InvalidRequest --> [*]

WaitingApproval --> Approved : Admin approves request
WaitingApproval --> Rejected : Admin rejects request
WaitingApproval --> OnHold : Admin requests additional info

Approved --> ProcessingTransfer : System deducts money,\ngenerates QR/PayOS/VNPay code
ProcessingTransfer --> Received : Seller confirms receipt of funds
ProcessingTransfer --> TransferFailed : Payment processing error
TransferFailed --> RetryTransfer : Retry payment
TransferFailed --> Cancelled : Exceed retry limit, refund balance
RetryTransfer --> ProcessingTransfer : Re-initiate transfer

Rejected --> Cancelled : Notify seller, request cancelled
OnHold --> WaitingApproval : Seller provides additional info
OnHold --> Cancelled : Seller does not respond within timeout

Received --> Completed : Transaction finalized
Cancelled --> [*]
Completed --> [*]
@enduml



@startuml
title Seller Registration - State Machine Diagram

[*] --> RegisteredUser : User submits registration form
RegisteredUser --> ValidationPending : System validates email & password
ValidationPending --> LoggedIn : Validation successful, login granted
ValidationPending --> InvalidRegistration : Invalid email/password
InvalidRegistration --> Cancelled : Notify user, registration failed
InvalidRegistration --> [*]

LoggedIn --> RequestingSeller : User requests seller role
RequestingSeller --> WaitingApproval : Submit seller registration info (ID, bank details)

WaitingApproval --> Approved : Admin approves request
Approved --> Seller : Update user status to Seller role
Seller --> SellerDashboard : Access Seller Dashboard
SellerDashboard --> ActiveSelling : Start managing products
ActiveSelling --> [*]

WaitingApproval --> Rejected : Admin rejects request
Rejected --> ResubmitRequest : User corrects info
Rejected --> Cancelled : User cancels or exceeds retry limit
ResubmitRequest --> WaitingApproval : Resubmit with updated info

Cancelled --> [*]
@enduml